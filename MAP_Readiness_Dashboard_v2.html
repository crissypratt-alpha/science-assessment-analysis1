<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alpha School ‚Äî MAP Science Readiness Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{--pri:#1a365d;--pri-l:#2c5282;--acc:#3182ce;--ok:#38a169;--warn:#d69e2e;--bad:#e53e3e;--bg:#f7fafc;--card:#fff;--txt:#2d3748;--txtL:#718096;--brd:#e2e8f0;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--txt);}
.hdr{background:linear-gradient(135deg,var(--pri),var(--pri-l));color:#fff;padding:24px 36px;display:flex;justify-content:space-between;align-items:center;}
.hdr h1{font-size:22px;font-weight:700;} .hdr .sub{opacity:.8;font-size:13px;margin-top:3px;} .hdr .dt{font-size:12px;opacity:.6;}
.wrap{max-width:1440px;margin:0 auto;padding:20px 28px;}
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:24px;}
.kpi{background:var(--card);border-radius:10px;padding:18px 20px;box-shadow:0 1px 3px rgba(0,0,0,.06);border-left:4px solid var(--acc);}
.kpi.g{border-left-color:var(--ok);} .kpi.r{border-left-color:var(--bad);} .kpi.y{border-left-color:var(--warn);} .kpi.p{border-left-color:#805ad5;}
.kpi-lab{font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--txtL);font-weight:600;}
.kpi-val{font-size:32px;font-weight:800;margin:4px 0 1px;}
.kpi .kpi-val{color:var(--acc);} .kpi.g .kpi-val{color:var(--ok);} .kpi.r .kpi-val{color:var(--bad);} .kpi.y .kpi-val{color:var(--warn);} .kpi.p .kpi-val{color:#805ad5;}
.kpi-sub{font-size:12px;color:var(--txtL);}
.tabs{display:flex;gap:5px;margin-bottom:18px;flex-wrap:wrap;}
.tab{padding:7px 18px;border:2px solid var(--brd);border-radius:7px;background:#fff;cursor:pointer;font-weight:600;font-size:13px;color:var(--txtL);transition:.2s;}
.tab:hover{border-color:var(--acc);color:var(--acc);} .tab.on{background:var(--acc);color:#fff;border-color:var(--acc);}
.card{background:var(--card);border-radius:10px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.06);margin-bottom:20px;}
.card h2{font-size:15px;font-weight:700;margin-bottom:14px;color:var(--pri);}
.row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:20px;}
.full{grid-column:1/-1;}
.sec{font-size:18px;font-weight:800;color:var(--pri);margin:28px 0 14px;padding-bottom:6px;border-bottom:3px solid var(--acc);}
.sec:first-of-type{margin-top:6px;}
table{width:100%;border-collapse:collapse;font-size:12px;}
th{text-align:left;padding:8px 10px;background:#f1f5f9;font-weight:600;color:var(--pri);border-bottom:2px solid var(--brd);position:sticky;top:0;z-index:1;}
td{padding:7px 10px;border-bottom:1px solid var(--brd);}
tr:hover td{background:#f8fafc;}
.b{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;}
.b-r{background:#fff5f5;color:var(--bad);} .b-y{background:#fffff0;color:#b7791f;} .b-g{background:#f0fff4;color:var(--ok);} .b-b{background:#ebf8ff;color:var(--acc);} .b-p{background:#faf5ff;color:#805ad5;} .b-gr{background:#f7fafc;color:var(--txtL);}
.scroll{max-height:500px;overflow-y:auto;} .scroll::-webkit-scrollbar{width:5px;} .scroll::-webkit-scrollbar-thumb{background:#cbd5e0;border-radius:3px;}
.ch{position:relative;height:300px;} .ch.t{height:380px;} .ch.s{height:240px;}
.bar-mini{display:flex;align-items:center;gap:6px;}
.bar-track{flex:1;background:#e2e8f0;border-radius:4px;height:8px;overflow:hidden;}
.bar-fill{height:100%;border-radius:4px;transition:.3s;}
.bar-label{font-size:11px;font-weight:700;min-width:36px;text-align:right;}
.filter-row{display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap;}
.filter-row label{font-size:12px;font-weight:600;color:var(--txtL);}
.filter-row select{padding:5px 10px;border:1px solid var(--brd);border-radius:6px;font-size:12px;background:#fff;}
.search-box{padding:5px 10px;border:1px solid var(--brd);border-radius:6px;font-size:12px;width:200px;}
@media(max-width:900px){.kpi-row{grid-template-columns:repeat(2,1fr);}.row,.row3{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="hdr">
  <div><h1>üî¨ MAP Science Readiness Dashboard</h1><div class="sub">Alpha School ‚Äî Grades 3‚Äì8 | Tests ¬∑ Questions ¬∑ NGSS Skills ¬∑ Student Performance</div></div>
  <div class="dt">Data as of Feb 2025</div>
</div>
<div class="wrap">

<!-- KPI -->
<div class="kpi-row">
  <div class="kpi"><div class="kpi-lab">Total MAP Standards</div><div class="kpi-val" id="k1">228</div><div class="kpi-sub">NGSS PEs Grades 3-8</div></div>
  <div class="kpi g"><div class="kpi-lab">Standards We Test</div><div class="kpi-val" id="k2">124</div><div class="kpi-sub" id="k2s">54% coverage</div></div>
  <div class="kpi r"><div class="kpi-lab">Testing Gaps</div><div class="kpi-val" id="k3">104</div><div class="kpi-sub">MAP tests, we don't</div></div>
  <div class="kpi y"><div class="kpi-lab">Below 75% Accuracy</div><div class="kpi-val" id="k4">36</div><div class="kpi-sub">Need reteaching</div></div>
  <div class="kpi p"><div class="kpi-lab">Tests Analyzed</div><div class="kpi-val" id="k5">42</div><div class="kpi-sub" id="k5s">with student data</div></div>
</div>

<!-- Grade Tabs -->
<div class="sec">üìã Grade-Level View</div>
<div class="tabs" id="gradeTabs"></div>

<!-- TAB 1: Tests in This Grade -->
<div class="card" id="testSection">
  <h2 id="testTitle">Grade 3 ‚Äî Test Inventory</h2>
  <div class="scroll" id="testTableWrap"></div>
</div>

<!-- TAB 2: Question Performance by Test -->
<div class="card" id="qSection">
  <h2 id="qTitle">Grade 3 ‚Äî Question Performance</h2>
  <div class="filter-row">
    <label>Test:</label><select id="testSelect" onchange="renderQuestionPerf()"></select>
  </div>
  <div class="scroll" style="max-height:600px" id="qTableWrap"></div>
</div>

<!-- TAB 3: NGSS Skills Matrix -->
<div class="sec">üéØ NGSS Skills Matrix ‚Äî MAP ¬∑ Test ¬∑ Teach ¬∑ Student Performance</div>
<div class="card">
  <div class="filter-row">
    <label>Grade:</label><select id="skillGradeSelect" onchange="renderSkillMatrix()"></select>
    <label style="margin-left:12px">Domain:</label><select id="skillDomainSelect" onchange="renderSkillMatrix()"></select>
    <label style="margin-left:12px">Status:</label><select id="skillStatusSelect" onchange="renderSkillMatrix()">
      <option value="all">All Standards</option>
      <option value="gap">Gaps Only (not tested)</option>
      <option value="weak">Weak Curriculum</option>
      <option value="urgent">Urgent Reteach (&lt;50%)</option>
      <option value="ok">On Track (‚â•75%)</option>
    </select>
    <input type="text" class="search-box" id="skillSearch" placeholder="Search standard..." oninput="renderSkillMatrix()">
  </div>
  <div class="scroll" style="max-height:700px" id="skillTableWrap"></div>
</div>

<!-- Overview Charts -->
<div class="sec">üìä Overview Charts</div>
<div class="row">
  <div class="card"><h2>Testing Coverage by Grade</h2><div class="ch"><canvas id="covChart"></canvas></div></div>
  <div class="card"><h2>Student Accuracy by NGSS Domain</h2><div class="ch"><canvas id="domChart"></canvas></div></div>
</div>
<div class="row">
  <div class="card"><h2>Gaps to Close by Grade</h2><div class="ch"><canvas id="gapChart"></canvas></div></div>
  <div class="card"><h2>Action Required Breakdown</h2><div class="ch"><canvas id="actChart"></canvas></div></div>
</div>

<div style="text-align:center;padding:20px 0 8px;">
  <a href="index.html" style="font-size:12px;color:#888;text-decoration:none;font-weight:600;letter-spacing:0.5px;opacity:0.6;transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">&#x2302; Home</a>
</div>

</div>

<script src="dashboard_data.js"></script>
<script>
// =========== HELPERS ===========
const grades=[3,4,5,6,7,8];
const domMap={LS:'Life Science',PS:'Physical Science',ESS:'Earth/Space Science',ETS:'Engineering/Technology'};
const domCol={LS:'#38a169',PS:'#3182ce',ESS:'#d69e2e',ETS:'#805ad5'};

function badge(action){
  const a=(action||'').toLowerCase();
  if(a.includes('urgent')) return '<span class="b b-r">URGENT</span>';
  if(a.includes('add to test')&&a.includes('add to curriculum')) return '<span class="b b-r">Add Test+Curriculum</span>';
  if(a.includes('add to test')) return '<span class="b b-y">Add to Test</span>';
  if(a.includes('strengthen')&&a.includes('reteach')) return '<span class="b b-y">Strengthen+Reteach</span>';
  if(a.includes('reteach')) return '<span class="b b-y">Reteach</span>';
  if(a.includes('strengthen')) return '<span class="b b-b">Strengthen</span>';
  if(a.includes('add to curriculum')) return '<span class="b b-b">Add Curriculum</span>';
  if(a.includes('no action')) return '<span class="b b-g">On Track</span>';
  return '<span class="b b-gr">'+action+'</span>';
}
function accColor(v){if(v==null)return'color:#a0aec0';if(v>=75)return'color:#38a169;font-weight:700';if(v>=50)return'color:#d69e2e;font-weight:700';return'color:#e53e3e;font-weight:700';}
function pctBar(v,max){
  if(v==null) return '<span style="color:#a0aec0">N/A</span>';
  const c=v>=75?'#38a169':v>=50?'#d69e2e':'#e53e3e';
  return `<div class="bar-mini"><div class="bar-track"><div class="bar-fill" style="width:${v}%;background:${c}"></div></div><div class="bar-label" style="${accColor(v)}">${Math.round(v)}%</div></div>`;
}

// =========== KPIs ===========
const completedTests = testInventory.filter(t=>t.completed);
const testsWithStudents = testInventory.filter(t=>t.students && t.students>0);
document.getElementById('k5').textContent = testsWithStudents.length;
document.getElementById('k5s').textContent = completedTests.length + ' completed analysis';

const tested = mapStandardsMatrix.filter(s=>s.tested==='Y').length;
const gaps = mapStandardsMatrix.filter(s=>s.tested==='N').length;
const below75 = mapStandardsMatrix.filter(s=>s.studentAccuracy!=null && s.studentAccuracy<75).length;
document.getElementById('k1').textContent = mapStandardsMatrix.length;
document.getElementById('k2').textContent = tested;
document.getElementById('k2s').textContent = Math.round(100*tested/mapStandardsMatrix.length)+'% coverage';
document.getElementById('k3').textContent = gaps;
document.getElementById('k4').textContent = below75;

// =========== GRADE TABS ===========
let curGrade=3;
const tabEl=document.getElementById('gradeTabs');
grades.forEach(g=>{
  const b=document.createElement('button');
  b.className='tab'+(g===3?' on':'');
  b.textContent='Grade '+g;
  b.onclick=()=>selectGrade(g);
  tabEl.appendChild(b);
});
function selectGrade(g){
  curGrade=g;
  document.querySelectorAll('.tab').forEach((b,i)=>b.className='tab'+(grades[i]===g?' on':''));
  renderTestTable(g);
  renderTestSelect(g);
  renderQuestionPerf();
}

// =========== TEST TABLE ===========
function renderTestTable(g){
  document.getElementById('testTitle').textContent=`Grade ${g} ‚Äî Test Inventory`;
  const tests=testInventory.filter(t=>t.grade===g);
  // group by test name and enrich with question count + performance
  let html='<table><thead><tr><th>Test</th><th>Students</th><th>Avg Accuracy</th><th># Questions</th><th>Status</th></tr></thead><tbody>';
  tests.forEach(t=>{
    const qs=questionData.filter(q=>q.testName===t.testName);
    const qcount=qs.length;
    const acc=t.accuracy;
    const accStr=acc!=null?pctBar(acc*100,100):'<span style="color:#a0aec0">No data</span>';
    const status=t.completed?'<span class="b b-g">‚úì Analyzed</span>':(t.students?'<span class="b b-y">Has Data</span>':'<span class="b b-gr">No Data</span>');
    html+=`<tr><td style="font-weight:600">${t.testName}</td><td>${t.students||'‚Äî'}</td><td>${accStr}</td><td>${qcount||'‚Äî'}</td><td>${status}</td></tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('testTableWrap').innerHTML=html;
}

// =========== QUESTION PERFORMANCE ===========
function renderTestSelect(g){
  const sel=document.getElementById('testSelect');
  const tests=[...new Set(questionPerformance.filter(q=>{
    const ti=testInventory.find(t=>t.testName===q.testName);
    return ti&&ti.grade===g;
  }).map(q=>q.testName))].sort();
  sel.innerHTML='<option value="">Select a test...</option>'+tests.map(t=>`<option value="${t}">${t}</option>`).join('');
}

function renderQuestionPerf(){
  document.getElementById('qTitle').textContent=`Grade ${curGrade} ‚Äî Question Performance`;
  const selTest=document.getElementById('testSelect').value;
  if(!selTest){document.getElementById('qTableWrap').innerHTML='<p style="color:#a0aec0;font-size:13px;padding:20px">Select a test above to see per-question performance.</p>';return;}

  const qs=questionPerformance.filter(q=>q.testName===selTest).sort((a,b)=>a.questionNum-b.questionNum);
  let html='<table><thead><tr><th style="width:50px">Q#</th><th>Question Stem</th><th>NGSS Standard</th><th style="width:50px">‚úì</th><th style="width:50px">Total</th><th style="width:140px">Accuracy</th><th>Topic</th></tr></thead><tbody>';
  qs.forEach(q=>{
    const acc=q.total>0?Math.round(100*q.correct/q.total):null;
    // Get stem from questionData
    const qd=questionData.find(d=>d.testName===selTest&&d.questionNum===q.questionNum);
    const stem=qd?qd.stemPreview:'';
    html+=`<tr>
      <td style="font-weight:700;text-align:center">${q.questionNum}</td>
      <td style="font-size:11px;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${stem}">${stem}</td>
      <td><span style="font-weight:600;color:${domCol[q.ngss?.split('-')[0]]||'#666'}">${q.ngss||'‚Äî'}</span></td>
      <td style="text-align:center;color:#38a169;font-weight:700">${q.correct}</td>
      <td style="text-align:center">${q.total}</td>
      <td>${pctBar(acc,100)}</td>
      <td style="font-size:11px;color:#718096">${q.topic||''}</td>
    </tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('qTableWrap').innerHTML=html;
}

// =========== NGSS SKILLS MATRIX ===========
// Populate filters
const sgSel=document.getElementById('skillGradeSelect');
sgSel.innerHTML='<option value="all">All Grades</option>'+grades.map(g=>`<option value="${g}">Grade ${g}</option>`).join('');
const sdSel=document.getElementById('skillDomainSelect');
sdSel.innerHTML='<option value="all">All Domains</option>'+Object.keys(domMap).map(d=>`<option value="${d}">${domMap[d]}</option>`).join('');

function renderSkillMatrix(){
  const gf=document.getElementById('skillGradeSelect').value;
  const df=document.getElementById('skillDomainSelect').value;
  const sf=document.getElementById('skillStatusSelect').value;
  const search=document.getElementById('skillSearch').value.toLowerCase();

  let data=mapStandardsMatrix.slice();
  if(gf!=='all') data=data.filter(s=>s.grade==gf);
  if(df!=='all') data=data.filter(s=>s.domain===df);
  if(sf==='gap') data=data.filter(s=>s.tested==='N');
  else if(sf==='weak') data=data.filter(s=>s.taught==='Weak');
  else if(sf==='urgent') data=data.filter(s=>s.studentAccuracy!=null&&s.studentAccuracy<50);
  else if(sf==='ok') data=data.filter(s=>s.studentAccuracy!=null&&s.studentAccuracy>=75);
  if(search) data=data.filter(s=>s.standard.toLowerCase().includes(search)||s.domain.toLowerCase().includes(search)||(s.action||'').toLowerCase().includes(search));

  let html=`<table><thead><tr>
    <th>Grade</th><th>NGSS Standard</th><th>Domain</th>
    <th style="text-align:center">On MAP?</th>
    <th style="text-align:center">We Test?</th>
    <th style="text-align:center">We Teach?</th>
    <th style="width:150px">Student Accuracy</th>
    <th>Action Needed</th>
  </tr></thead><tbody>`;

  data.forEach(s=>{
    const acc=s.studentAccuracy;
    html+=`<tr>
      <td style="font-weight:700">G${s.grade}</td>
      <td style="font-weight:600">${s.standard}</td>
      <td><span style="color:${domCol[s.domain]||'#666'};font-weight:600">${domMap[s.domain]||s.domain}</span></td>
      <td style="text-align:center">‚úÖ</td>
      <td style="text-align:center">${s.tested==='Y'?'‚úÖ':'‚ùå'}</td>
      <td style="text-align:center">${s.taught==='Y'?'‚úÖ':s.taught==='Weak'?'‚ö†Ô∏è':'‚ùå'}</td>
      <td>${pctBar(acc,100)}</td>
      <td>${badge(s.action)}</td>
    </tr>`;
  });
  html+='</tbody></table>';
  html+=`<div style="font-size:12px;color:#718096;margin-top:8px;padding:4px">Showing ${data.length} of ${mapStandardsMatrix.length} standards</div>`;
  document.getElementById('skillTableWrap').innerHTML=html;
}

// =========== OVERVIEW CHARTS ===========
// Coverage by grade
function gradeStats(g){
  const stds=mapStandardsMatrix.filter(s=>s.grade==g);
  const t=stds.filter(s=>s.tested==='Y').length;
  const gap=stds.filter(s=>s.tested==='N').length;
  return {total:stds.length, tested:t, gap};
}
new Chart(document.getElementById('covChart'),{
  type:'bar',data:{
    labels:grades.map(g=>'G'+g),
    datasets:[
      {label:'Tested',data:grades.map(g=>gradeStats(g).tested),backgroundColor:'#38a169'},
      {label:'Gap',data:grades.map(g=>gradeStats(g).gap),backgroundColor:'#fc8181'}
    ]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{x:{stacked:true},y:{stacked:true,title:{display:true,text:'Standards'}}}}
});

// Domain accuracy
function domainAvgs(){
  const doms=['LS','PS','ESS','ETS'];
  return doms.map(d=>{
    const stds=mapStandardsMatrix.filter(s=>s.domain===d&&s.studentAccuracy!=null);
    if(!stds.length)return 0;
    return Math.round(stds.reduce((a,s)=>a+s.studentAccuracy,0)/stds.length);
  });
}
new Chart(document.getElementById('domChart'),{
  type:'bar',data:{
    labels:Object.values(domMap),
    datasets:[{label:'Avg Student Accuracy %',data:domainAvgs(),backgroundColor:Object.values(domCol),borderRadius:6}]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{min:0,max:100,title:{display:true,text:'Accuracy %'}}}}
});

// Gaps chart
new Chart(document.getElementById('gapChart'),{
  type:'bar',data:{
    labels:grades.map(g=>'G'+g),
    datasets:[
      {label:'Not Tested',data:grades.map(g=>gradeStats(g).gap),backgroundColor:'#e53e3e',borderRadius:4},
      {label:'Not Taught (‚ùå)',data:grades.map(g=>mapStandardsMatrix.filter(s=>s.grade==g&&s.taught==='N').length),backgroundColor:'#805ad5',borderRadius:4},
      {label:'Below 75%',data:grades.map(g=>mapStandardsMatrix.filter(s=>s.grade==g&&s.studentAccuracy!=null&&s.studentAccuracy<75).length),backgroundColor:'#d69e2e',borderRadius:4}
    ]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}
});

// Action summary
function actionCounts(){
  let noAct=0,str=0,ret=0,addT=0,addBoth=0;
  mapStandardsMatrix.forEach(s=>{
    const a=(s.action||'').toLowerCase();
    if(a.includes('no action'))noAct++;
    else if(a.includes('add to test')&&a.includes('add to curriculum'))addBoth++;
    else if(a.includes('add to test'))addT++;
    else if(a.includes('urgent')||(a.includes('reteach')&&!a.includes('strengthen')))ret++;
    else if(a.includes('strengthen'))str++;
    else ret++;
  });
  return[noAct,str,ret,addT,addBoth];
}
const ac=actionCounts();
new Chart(document.getElementById('actChart'),{
  type:'doughnut',data:{
    labels:['No Action','Strengthen Curriculum','Reteach','Add to Tests','Add Test+Curriculum'],
    datasets:[{data:ac,backgroundColor:['#38a169','#d69e2e','#ed8936','#e53e3e','#9b2c2c'],borderWidth:2}]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}
});

// =========== INIT ===========
selectGrade(3);
renderSkillMatrix();
</script>
</body>
</html>